<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Ghostlet — Market</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://bjgxufxgpgojkwqbdyqp.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZ3h1ZnhncGdvamt3cWJkeXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTk1NjMsImV4cCI6MjA3ODk3NTU2M30.BRyjh8E2WK1KTquDhzfBtAmcBuxhZ4jRsZQgN_5s9rg";
  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
</script>

<style>
  html,body{margin:0;padding:0;overflow-x:hidden;background:#050505;color:#fff;font-family:Segoe UI,Arial}
  .topbar{width:100%;background:#070707;padding:12px 20px;border-bottom:3px solid #00fef0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .topbar-left{color:#00fef0;font-weight:800;font-size:20px}
  .topbar-right{display:flex;gap:12px;flex-wrap:wrap}
  .topbar-right a{color:#fff;text-decoration:none;padding:8px 12px;border-radius:8px}
  .topbar-right a:hover{background:#00fef0;color:#000}
  .page-container{max-width:1100px;margin:24px auto;padding:20px;width:calc(100% - 40px)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
  .pack{background:#0e0e0e;padding:16px;border-radius:12px;text-align:center}
  .pack img{width:120px;height:120px;object-fit:contain}
  .pack h3{color:#00fef0;margin:8px 0}
  .openBtn{background:#00fef0;color:#000;border:none;padding:10px 12px;border-radius:10px;cursor:pointer}
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-left">Ghostlet</div>
    <div class="topbar-right" id="navLinks"></div>
  </div>

  <div class="page-container">
    <h1 style="color:#00fef0">Market — Packs</h1>
    <div id="packsGrid" class="grid"></div>
  </div>

<script>
  // sample packs (4 packs per your request)
  const PACKS = [
    { id: 'og', name:'OG Pack', image:'https://i.ibb.co/fHcnPzp/midnight-pack.png',
      blooks: [
        {id:'star_001',name:'Falling Star',rarity:'Common',image:'https://i.ibb.co/1JkPZVW/faolling-star.png', weight:50},
        {id:'planet_001',name:'Cursed Planet',rarity:'Uncommon',image:'https://i.ibb.co/ZBjm3Sd/cuirsed-planet.png', weight:25},
        {id:'galaxy_001',name:'Rainbow Galaxy',rarity:'Chroma',image:'https://i.ibb.co/wgmNW4G/rainboow-galaxy.png', weight:1}
      ]},
    { id:'spooky', name:'Spooky Pack', image:'https://i.ibb.co/7rXxLxk/spooky-pack.png',
      blooks: [
        {id:'ghost_001',name:'Friendly Ghost',rarity:'Common',image:'https://i.ibb.co/0FQG7kF/frieindly-ghost.png',weight:50},
        {id:'phantom_001',name:'Dark Phantom',rarity:'Epic',image:'https://i.ibb.co/wrgvXc0/spooky-phanitom.png',weight:7},
        {id:'specter_001',name:'Glowing Specter',rarity:'Chroma',image:'https://i.ibb.co/KV9h7dD/glowinog-specter.png',weight:1}
      ]},
    { id:'holiday', name:'Holiday Pack', image:'https://i.ibb.co/Y7zV6J0/holiday-pack.png',
      blooks: [
        {id:'christmas_001',name:'Christmas',rarity:'Common',image:'https://i.ibb.co/0FQG7kF/friendly-ghost.png',weight:60},
        {id:'pumpkin_001',name:'Pumpkin',rarity:'Uncommon',image:'https://i.ibb.co/fdH9x8x/hiaunted-cookie.png',weight:30},
        {id:'hallow_001',name:'Halloween',rarity:'Rare',image:'https://i.ibb.co/FH7xW3B/halloween.png',weight:10}
      ]},
    { id:'emoji', name:'Emoji Pack', image:'https://i.ibb.co/3Nv4gkv/mystery-pack.png',
      blooks: [
        {id:'smile_001',name:'Smiley',rarity:'Common',image:'https://i.ibb.co/0FQG7kF/smiley-emoji.png',weight:40},
        {id:'angry_001',name:'Angry',rarity:'Uncommon',image:'https://i.ibb.co/fdH9x8x/angry-emoji.png',weight:35},
        {id:'laugh_001',name:'Laughing',rarity:'Rare',image:'https://i.ibb.co/NV8Lkk6/laughing-emoji.png',weight:25}
      ]}
  ];

  // nav
  async function setupNav(){
    const { data: { session } } = await supabase.auth.getSession();
    const nav = document.getElementById('navLinks');
    if (!session) { nav.innerHTML = `<a href="login.html">Login</a>`; return; }
    nav.innerHTML = `<a href="index.html">Home</a><a href="blooks.html">Blooks</a><a href="stats.html">Stats</a><a href="chat.html">Chat</a><a href="#" id="logout">Logout</a>`;
    document.getElementById('logout').onclick = async ()=>{ await supabase.auth.signOut(); location.href='login.html' };
  }
  setupNav();

  // render packs
  const grid = document.getElementById('packsGrid');
  function renderPacks(){
    grid.innerHTML = '';
    for (const p of PACKS){
      const el = document.createElement('div'); el.className='pack';
      el.innerHTML = `<img src="${p.image}"><h3>${p.name}</h3><div style="color:#aaa;margin-bottom:8px">${p.blooks.length} blooks</div><button class="openBtn">Open</button>`;
      el.querySelector('.openBtn').onclick = ()=> openPack(p);
      grid.appendChild(el);
    }
  }
  renderPacks();

  function pickWeighted(blooks){
    const weights = blooks.map(b => Math.max(1,b.weight||1));
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    for (let i=0;i<blooks.length;i++){
      r -= weights[i];
      if (r <= 0) return blooks[i];
    }
    return blooks[blooks.length-1];
  }

  async function openPack(pack){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return location.href='login.html';
    const uid = session.user.id;

    // simple reveal UI
    const selected = pickWeighted(pack.blooks||[]);
    alert(`You opened: ${selected.name} (${selected.rarity})`);

    // save to blooks table
    await supabase.from('blooks').insert([{
      user_id: uid,
      pack_id: pack.id,
      blook_id: selected.id,
      name: selected.name,
      image: selected.image,
      rarity: selected.rarity
    }]);

    // increment counters in profiles
    // fetch profile (current counts)
    const { data: profile } = await supabase.from('profiles').select('packs_opened,blooks_owned').eq('id', uid).single();
    const packsOpened = (profile?.packs_opened || 0) + 1;
    const blooksOwned = (profile?.blooks_owned || 0) + 1;
    await supabase.from('profiles').update({ packs_opened: packsOpened, blooks_owned: blooksOwned }).eq('id', uid);

    // redirect or show toast
    location.href = 'blooks.html';
  }
</script>
</body>
</html>
